
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>حضوري - تسجيل الحضور</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style> body{font-family: Arial, sans-serif; direction: rtl;} #map{height:300px} .box{max-width:600px;margin:20px auto;padding:15px;border:1px solid #ddd;border-radius:6px;} label{display:block;margin-top:8px;} button{margin-top:10px;padding:10px 15px;} </style>
</head>
<body>
  <div class="box">
    <h2>حضوري - تسجيل الحضور للمعهد الصناعي الثانوي بالرس</h2>
    <div id="map"></div>
    <form id="attForm">
      <label>الهوية: <input id="nid" required /></label>
      <button type="submit">تحضير</button>
    </form>
    <div id="msg"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const CENTER = {lat:25.8969550,lng:43.5497960};
    const RADIUS_M = 100;
    function getDeviceId(){
      let id = localStorage.getItem('device_id');
      if(!id){
        id = 'd-' + Math.random().toString(36).slice(2) + '-' + Date.now();
        localStorage.setItem('device_id', id);
      }
      return id;
    }
    const deviceId = getDeviceId();
    const map = L.map('map').setView([CENTER.lat, CENTER.lng], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const centerMarker = L.circle([CENTER.lat, CENTER.lng], {radius:RADIUS_M}).addTo(map);
    L.marker([CENTER.lat, CENTER.lng]).addTo(map).bindPopup('محيط المعهد (100م)');
    let userMarker;
    function showMsg(t, color='black'){ const el = document.getElementById('msg'); el.innerHTML = '<p style="color:'+color+'">'+t+'</p>'; }
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat,lng]).addTo(map).bindPopup('موقعك');
        map.setView([lat,lng],17);
      }, err=>{
        showMsg('تعذر الحصول على الموقع: الرجاء تفعيل تحديد الموقع في جهازك', 'red');
      });
    } else {
      showMsg('المتصفح لا يدعم تحديد الموقع', 'red');
    }
    function toRad(x){ return x*Math.PI/180; }
    function distance(lat1,lon1,lat2,lon2){
      const R=6371000;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }
    document.getElementById('attForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nid = document.getElementById('nid').value.trim();
      showMsg('جاري إرسال طلب التحضير...');
      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        const dist = distance(lat,lng,CENTER.lat,CENTER.lng);
        if(dist > RADIUS_M){ showMsg('أنت خارج نطاق 100 متر من المعهد. المسافة: '+Math.round(dist)+' م', 'red'); return; }
        try{
          const res = await fetch('/api/attendance', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ national_id: nid, lat, lng, device_id: deviceId })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'خطأ');
          showMsg('تم تسجيل الحضور بنجاح', 'green');
        }catch(err){
          showMsg('فشل: '+err.message, 'red');
        }
      }, err=>{
        showMsg('تعذر الحصول على الموقع: '+err.message, 'red');
      });
    });
  </script>
</body>
</html>
